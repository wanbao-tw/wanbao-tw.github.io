---
import BaseLayout from '../../layouts/BaseLayout.astro';
import DiscordComments from '../../components/DiscordComments.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content } = await article.render();

// å–å¾—ç›¸é—œæ–‡ç« ï¼ˆåŒæ¨™ç±¤çš„å…¶ä»–æ–‡ç« ï¼‰
const allArticles = await getCollection('articles', ({ data }) => !data.draft);
const relatedArticles = allArticles
  .filter(a => a.slug !== article.slug && a.data.tag === article.data.tag)
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 3);

// SEO è³‡æ–™
const articleKeywords = [
  ...(article.data.keywords || []),
  article.data.tagName,
  article.data.game,
  article.data.vtuberName,
  'ç©å ±',
  'WANBAO'
].filter(Boolean);
---

<BaseLayout 
  title={article.data.title} 
  description={article.data.description || `${article.data.title} - ç©å ± WANBAO`}
  keywords={articleKeywords}
  image={article.data.image}
  type="article"
  publishedTime={article.data.date}
  modifiedTime={article.data.updateDate}
  author={article.data.author}
  section={article.data.tagName}
  tags={articleKeywords}
>
  <article class="article-page">
    <header class="article-header">
      <div class="article-meta-top">
        <span class={`article-card__tag tag-${article.data.tag}`}>{article.data.tagName}</span>
        {article.data.game && <span class="game-tag">ğŸ® {article.data.game}</span>}
        {article.data.vtuberName && <span class="vtuber-tag">ğŸ¦Š {article.data.vtuberName}</span>}
      </div>
      <h1>{article.data.title}</h1>
      <div class="article-meta">
        <span>ğŸ“… {article.data.date}</span>
        <span>âœï¸ {article.data.author}</span>
        {article.data.readingTime && <span>â±ï¸ ç´„ {article.data.readingTime} åˆ†é˜</span>}
        {article.data.updateDate && <span>ğŸ”„ æ›´æ–°æ–¼ {article.data.updateDate}</span>}
      </div>
    </header>

    {article.data.image && (
      <img src={article.data.image} alt={article.data.title} class="article-cover" />
    )}

    <div class="article-body">
      <Content />
    </div>

    <!-- æ–‡ç« æ¨™ç±¤ -->
    {article.data.keywords && article.data.keywords.length > 0 && (
      <div class="article-tags">
        <span class="tags-label">ğŸ·ï¸ æ¨™ç±¤ï¼š</span>
        {article.data.keywords.map((keyword: string) => (
          <a href={`/search?q=${encodeURIComponent(keyword)}`} class="tag-link">{keyword}</a>
        ))}
      </div>
    )}

    <!-- åˆ†äº«æŒ‰éˆ• -->
    <div class="share-section">
      <span class="share-label">ğŸ“¤ åˆ†äº«æ–‡ç« ï¼š</span>
      <div class="share-buttons">
        <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(`https://wanbao.tw/articles/${article.slug}`)}`} target="_blank" rel="noopener" class="share-btn share-fb" title="åˆ†äº«åˆ° Facebook">
          FB
        </a>
        <a href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(`https://wanbao.tw/articles/${article.slug}`)}&text=${encodeURIComponent(article.data.title)}`} target="_blank" rel="noopener" class="share-btn share-twitter" title="åˆ†äº«åˆ° Twitter">
          ğ•
        </a>
        <a href={`https://line.me/R/msg/text/?${encodeURIComponent(article.data.title)}%0D%0A${encodeURIComponent(`https://wanbao.tw/articles/${article.slug}`)}`} target="_blank" rel="noopener" class="share-btn share-line" title="åˆ†äº«åˆ° LINE">
          LINE
        </a>
        <button class="share-btn share-copy" onclick="copyLink()" title="è¤‡è£½é€£çµ">
          ğŸ“‹
        </button>
      </div>
    </div>

    <!-- ç›¸é—œæ–‡ç«  -->
    {relatedArticles.length > 0 && (
      <div class="related-articles">
        <h3>ğŸ“š ç›¸é—œæ–‡ç« </h3>
        <div class="related-grid">
          {relatedArticles.map((related) => (
            <a href={`/articles/${related.slug}`} class="related-card">
              <span class={`related-tag tag-${related.data.tag}`}>{related.data.tagName}</span>
              <h4>{related.data.title}</h4>
              <span class="related-date">{related.data.date}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Discord ç•™è¨€å€ -->
    {article.data.showComments !== false && (
      <DiscordComments articleSlug={article.slug} />
    )}

    <div class="article-nav">
      <a href="/" class="btn btn-primary">â† è¿”å›é¦–é </a>
      <a href={`/${article.data.tag === 'vtuber' ? 'vtuber' : article.data.tag === 'guide' ? 'guide' : 'news'}`} class="btn btn-secondary">
        æ›´å¤š{article.data.tagName}
      </a>
    </div>
  </article>
</BaseLayout>

<script>
  function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(() => {
      alert('é€£çµå·²è¤‡è£½ï¼');
    });
  }
  window.copyLink = copyLink;
</script>

<style>
  .article-page {
    max-width: 800px;
    margin: 0 auto;
  }
  
  .article-header {
    margin-bottom: var(--spacing-lg);
  }
  
  .article-meta-top {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-sm);
  }
  
  .game-tag, .vtuber-tag {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--color-bg);
    color: var(--color-text-light);
  }
  
  .article-header h1 {
    font-size: 2rem;
    line-height: 1.3;
    margin-bottom: var(--spacing-sm);
    color: var(--color-secondary);
  }
  
  .article-meta {
    color: var(--color-text-light);
    font-size: 0.9rem;
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
  }
  
  .article-cover {
    width: 100%;
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-lg);
  }
  
  .article-body {
    background: var(--color-bg-card);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }
  
  .article-tags {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-md);
    background: var(--color-bg-card);
    border-radius: var(--radius-md);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--spacing-xs);
  }
  
  .tags-label {
    font-weight: 500;
    color: var(--color-text-light);
  }
  
  .tag-link {
    padding: 4px 12px;
    background: var(--color-bg);
    border-radius: 20px;
    font-size: 0.85rem;
    color: var(--color-text);
    transition: all var(--transition-fast);
  }
  
  .tag-link:hover {
    background: var(--color-primary);
    color: white;
  }
  
  .share-section {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-md);
    background: var(--color-bg-card);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }
  
  .share-label {
    font-weight: 500;
    color: var(--color-text-light);
  }
  
  .share-buttons {
    display: flex;
    gap: var(--spacing-xs);
  }
  
  .share-btn {
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.85rem;
    transition: all var(--transition-fast);
    border: none;
    cursor: pointer;
    text-decoration: none;
  }
  
  .share-fb {
    background: #1877F2;
    color: white;
  }
  
  .share-twitter {
    background: #000;
    color: white;
  }
  
  .share-line {
    background: #00B900;
    color: white;
  }
  
  .share-copy {
    background: var(--color-bg);
    color: var(--color-text);
  }
  
  .share-btn:hover {
    opacity: 0.85;
    transform: translateY(-2px);
  }
  
  .related-articles {
    margin-top: var(--spacing-xl);
  }
  
  .related-articles h3 {
    color: var(--color-secondary);
    margin-bottom: var(--spacing-md);
  }
  
  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
  }
  
  .related-card {
    padding: var(--spacing-md);
    background: var(--color-bg-card);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-fast);
    display: block;
  }
  
  .related-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
  }
  
  .related-tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
    color: white;
    margin-bottom: var(--spacing-xs);
  }
  
  .related-card h4 {
    font-size: 0.95rem;
    color: var(--color-text);
    line-height: 1.4;
    margin-bottom: var(--spacing-xs);
  }
  
  .related-date {
    font-size: 0.8rem;
    color: var(--color-text-light);
  }
  
  .article-nav {
    margin-top: var(--spacing-xl);
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
  }
  
  @media (max-width: 768px) {
    .article-header h1 {
      font-size: 1.5rem;
    }
    
    .article-nav {
      flex-direction: column;
    }
    
    .share-section {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
