---
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import { getCollection } from 'astro:content';

// å–å¾—æœå°‹é—œéµå­—
const query = Astro.url.searchParams.get('q')?.trim().toLowerCase() || '';

// å–å¾—æ‰€æœ‰å·²ç™¼ä½ˆæ–‡ç« 
const allArticles = await getCollection('articles', ({ data }) => !data.draft);

// æœå°‹é‚è¼¯ - æœå°‹æ¨™é¡Œã€æè¿°ã€å…§å®¹ã€æ¨™ç±¤ã€é—œéµå­—
let results: typeof allArticles = [];

if (query) {
  results = allArticles.filter((article) => {
    const title = article.data.title.toLowerCase();
    const description = (article.data.description || '').toLowerCase();
    const tagName = article.data.tagName.toLowerCase();
    const author = article.data.author.toLowerCase();
    const keywords = (article.data.keywords || []).join(' ').toLowerCase();
    const game = (article.data.game || '').toLowerCase();
    const series = (article.data.series || '').toLowerCase();
    
    return (
      title.includes(query) ||
      description.includes(query) ||
      tagName.includes(query) ||
      author.includes(query) ||
      keywords.includes(query) ||
      game.includes(query) ||
      series.includes(query)
    );
  });
  
  results.sort((a, b) => 
    new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
  );
}
---

<BaseLayout 
  title={query ? `æœå°‹ï¼š${query}` : 'æœå°‹'} 
  description={`åœ¨ç©å ±æœå°‹ã€Œ${query}ã€çš„çµæœ`}
>
  <section class="search-page">
    <header class="search-header">
      <h1>ğŸ” æœå°‹æ–‡ç« </h1>
      
      <form action="/search" method="GET" class="search-form-large">
        <input 
          type="search" 
          name="q" 
          value={query}
          placeholder="è¼¸å…¥é—œéµå­—æœå°‹..." 
          class="search-input-large"
          autofocus
        />
        <button type="submit" class="btn btn-primary">æœå°‹</button>
      </form>
    </header>

    {query && (
      <div class="search-meta">
        <p>
          æœå°‹ã€Œ<strong>{query}</strong>ã€ï¼Œæ‰¾åˆ° <strong>{results.length}</strong> ç¯‡ç›¸é—œæ–‡ç« 
        </p>
      </div>
    )}

    {query && results.length > 0 ? (
      <div class="articles-grid">
        {results.map((article) => (
          <ArticleCard
            title={article.data.title}
            tag={article.data.tag}
            tagName={article.data.tagName}
            date={article.data.date}
            author={article.data.author}
            slug={article.slug}
            image={article.data.image}
          />
        ))}
      </div>
    ) : query ? (
      <div class="empty-state">
        <div class="empty-state__icon">ğŸ”</div>
        <p>æ‰¾ä¸åˆ°ç¬¦åˆã€Œ{query}ã€çš„æ–‡ç« </p>
        <p style="font-size: 0.9rem; margin-top: 0.5rem; color: var(--color-text-light);">
          è©¦è©¦å…¶ä»–é—œéµå­—ï¼Œæˆ–ç€è¦½ä¸‹æ–¹åˆ†é¡
        </p>
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
          <a href="/guide" class="btn btn-secondary">ğŸ“– æ”»ç•¥</a>
          <a href="/vtuber" class="btn btn-secondary">ğŸ¦Š VTuber</a>
          <a href="/news" class="btn btn-secondary">ğŸ“° æ–°è</a>
        </div>
      </div>
    ) : (
      <div class="search-suggestions">
        <h2>ç†±é–€æœå°‹</h2>
        <div class="suggestion-tags">
          <a href="/search?q=TFT" class="suggestion-tag">TFT</a>
          <a href="/search?q=VTuber" class="suggestion-tag">VTuber</a>
          <a href="/search?q=æ”»ç•¥" class="suggestion-tag">æ”»ç•¥</a>
          <a href="/search?q=å°ˆè¨ª" class="suggestion-tag">å°ˆè¨ª</a>
          <a href="/search?q=ç¨ç«‹éŠæˆ²" class="suggestion-tag">ç¨ç«‹éŠæˆ²</a>
        </div>
        
        <h2 style="margin-top: 2rem;">ç€è¦½åˆ†é¡</h2>
        <div class="category-grid" style="margin-top: 1rem;">
          <a href="/guide" class="category-card">
            <div class="category-card__icon">ğŸ“–</div>
            <h3>éŠæˆ²æ”»ç•¥</h3>
          </a>
          <a href="/vtuber" class="category-card">
            <div class="category-card__icon">ğŸ¦Š</div>
            <h3>VTuber</h3>
          </a>
          <a href="/news" class="category-card">
            <div class="category-card__icon">ğŸ“°</div>
            <h3>æ–°è</h3>
          </a>
        </div>
      </div>
    )}
  </section>
</BaseLayout>

<style>
  .search-page {
    max-width: 1000px;
    margin: 0 auto;
  }
  
  .search-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  
  .search-header h1 {
    color: var(--color-secondary);
    margin-bottom: 1.5rem;
  }
  
  .search-form-large {
    display: flex;
    gap: 0.5rem;
    max-width: 600px;
    margin: 0 auto;
  }
  
  .search-input-large {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 1rem;
    font-family: inherit;
    transition: border-color var(--transition-fast);
  }
  
  .search-input-large:focus {
    outline: none;
    border-color: var(--color-primary);
  }
  
  .search-meta {
    background: var(--color-bg-card);
    padding: 1rem 1.5rem;
    border-radius: var(--radius-sm);
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
  }
  
  .search-meta p {
    margin: 0;
    color: var(--color-text-light);
  }
  
  .search-suggestions {
    text-align: center;
    padding: 2rem;
  }
  
  .search-suggestions h2 {
    color: var(--color-secondary);
    font-size: 1.2rem;
    margin-bottom: 1rem;
  }
  
  .suggestion-tags {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .suggestion-tag {
    padding: 0.5rem 1rem;
    background: var(--color-bg-card);
    border: 2px solid var(--color-border);
    border-radius: 20px;
    font-size: 0.9rem;
    transition: all var(--transition-fast);
  }
  
  .suggestion-tag:hover {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }
  
  @media (max-width: 768px) {
    .search-form-large {
      flex-direction: column;
    }
  }
</style>
